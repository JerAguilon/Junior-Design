{% extends 'dashboard.html' %}

{% block page_name %}
{{page_name}}
{% endblock page_name %}

{% block scripts %}
<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
<script src="/__/firebase/4.9.1/firebase-app.js"></script>
<script src="/__/firebase/4.9.1/firebase-auth.js"></script>
<script src="/__/firebase/4.9.1/firebase-database.js"></script>

<script src="/__/firebase/init.js"></script>

<script>

	// html template for new project after being created
	var newProjectFormat = `
        <div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--6-col mdl-grid mdl-grid mdl-cell--6-col project-card" data-name="{0}">
            <div class="project-circle">
                <div class="project-circle-text">
                      {1}
                </div>
            </div>
            <div class="mdl-cell project-card-description" >
                <div class="mdl-cell mdl-cell--12-col project-card-header">
                    {2}
                    <hr>
                </div>
                <div class="mdl-cell mdl-cell--12-col">
                    <div class="mdl-cell--12-col">
                        <b>Current Goal: </b>None
                    </div>
                    <div class="mdl-cell--12-col">
                        <b>Last Updated: </b> {3}
                    </div>
                </div>
            </div>
        </div>`;
    $(document).on('keyup keypress', 'form input[type="text"]', function(e) {
      if(e.which == 13) {
        e.preventDefault();
        return false;
      }
    });

	// initialize firebase app
	var config = {
	apiKey: "AIzaSyDpcs6rtT7S0e0W8u5tYrhHZWvaW7P_gUE",
	authDomain: "writers-bloc.firebaseapp.com",
	databaseURL: "https://writers-bloc.firebaseio.com",
	projectId: "writers-bloc",
	};
	firebase.initializeApp(config);

	// Get user and all of their projects
	var user = firebase.auth().currentUser;
	if (user) {
		var projectsRef = firebase.database().ref('users/' + user).child('/projects').orderByKey();

		// traverse through user projects and render HTML cards
		query.once('value').then(function(snapshot) {
			snapshot.forEach(function(childSnapshot) {
			var key = childSnapshot.key;
			var projectData = childSnapshot.val();

			var newProjectHtml =  newProjectFormat.format(
				projectData.name,
				projectData.name.substring(0, 1),
				projectData.name,
				projectData.creation_date);
			$('.project-list>div:eq(0)').after(newProjectHtml);
			});
		});
	} else {
		console.log("Invalid user");
	}

	// js form to create new project
    $(document).on('click', '.project-card:not(".add-project-card")', function() {
        window.location.replace('/projects/' + $(this).attr('data-name'));
        console.log($(this).attr('data-name'));
    });
    var addProjectForm = `
        <form action="#" class="modal-form">
            <div class="mdl-textfield mdl-js-textfield">
                <input class="mdl-textfield__input" type="textarea" id="project" />
                <label class="mdl-textfield__label" for="project">Project</label>
            </div>
        </form>`;

    // logic for creating new cards after new project form is completed
    $('.add-project-card').click(function() {
        showDialog({
                text: addProjectForm,
                negative: {
                    title: 'Cancel'
                },
                positive: {
                    title: 'Add Project',
                    onClick: function (e) {
                        var project = $("#project").val();
                        if (project) {
                            var currentTime = moment();
                            var newProjectHtml =  newProjectFormat.format(
                                    project,
                                    project.substring(0, 1),
                                    project,
                                    currentTime.calendar());
                            $('.project-list>div:eq(0)').after(newProjectHtml);
                            //element.insertAdjacentHTML('beforeend', newGoalHtml)


							// In case we need to have a listener.
							//var newProject = (insert var name here).push();
							//newProject.set({
							//	name: project,
							//	creation_date: Date().toLocaleString()
							//});

                            $.ajax({
                                url: '/new_project',
                                data: {'project_name': project},
                                type: 'POST',
                                success: function(response){
                                    console.log(response);
                                },
                                error: function(error){
                                    console.log(error);
                                }
                            });
                        } else {
                            alert("Invalid project.");
                        }
                    }
                }
        });
    });
</script>


{% endblock scripts %}

{% block content %}
<form method="POST">
	<div class='mdl-grid project-list'>
		<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--6-col mdl-grid mdl-grid mdl-cell--6-col project-card add-project-card">
			<div class="project-circle project-add-circle">
				<div class="project-circle-text">
					+
				</div>
			</div>
			<div class="mdl-cell project-card-description">
				<div class="mdl-cell mdl-cell--10-col project-card-header">
					Add Project
					<hr>
				</div>
			</div>
		</div>
		<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--6-col mdl-grid mdl-grid mdl-cell--6-col project-card" data-name="Personal Journal of Short Stories">
			<div class="project-circle">
				<div class="project-circle-text">
					P
				</div>
			</div>

			<div class="mdl-cell project-card-description" >
				<div class="mdl-cell mdl-cell--12-col project-card-header">
					Personal Journal of Short Stories
					<hr>
				</div>
				<div class="mdl-cell mdl-cell--12-col">
					<div class="mdl-cell--12-col">
						<b>Current Goal: </b>Complete Under and Above short story
					</div>
					<div class="mdl-cell--12-col">
						<b>Last Updated: </b> Nov. 5 at 4:14pm
					</div>
				</div>

			</div>
		</div>

		<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--6-col mdl-grid mdl-grid mdl-cell--6-col project-card" data-name="AE Research">
			<div class="project-circle">
				<div class="project-circle-text">
					A
				</div>
			</div>

			<div class="mdl-cell project-card-description">
				<div class="mdl-cell mdl-cell--12-col project-card-header">
					AE Research
					<hr>
				</div>
				<div class="mdl-cell mdl-cell--12-col">
					<div class="mdl-cell--12-col">
						<b>Current Goal: </b>Complete executive summary v. 1.1
					</div>
					<div class="mdl-cell--12-col">
						<b>Last Updated: </b> Nov. 4 at 8:19pm
					</div>
				</div>

			</div>
		</div>
	</div>
</form>
{% endblock content %}
